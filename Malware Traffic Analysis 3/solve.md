# CyberDefenders - Malware Traffic Analysis 3
<br />

## Scenario:
#### The attached PCAP belongs to an Exploitation Kit infection. Analyze it using your favorite tool and answer the challenge questions.
<br />

### Questions:

### Q1/. What is the IP address of the infected Windows host? 
#### A lot of traffic on this IP.
![1](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/54692066-dedb-4a14-b0ea-c2fa834ed38b)
#### > 192.168.137.62
<br />

### Q2/. What is the Exploit kit (EK) name? (two words)
#### This can be seen using PacketTotal and uploading the PCAP file.
#### > Angler EK
<br />

### Q3/. What is the FQDN that delivered the exploit kit?
#### We retrieved the IP from PacketTotal, let's filter it with tshark.
![3](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/7dc1bcd9-488f-41b7-9e66-7f6cef3535cf)
#### > qwe.mvdunalterableairreport.net
<br />

### Q4/. What is the redirect URL that points to the exploit kit landing page?
#### Filtering with tshark the http streams.
![4](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/a86d8e64-f543-4a0b-9536-3926b0de0d43)
#### > http://lifeinsidedetroit.com/02024870e4644b68814aadfbb58a75bc.php?q=e8bd3799ee8799332593b0b9caa1f426
<br />

### Q5/. What is the FQDN of the compromised website?
#### Filtering only http requests we see some traffic involving a wordpress website. Filtering the IP retrieved gives us the FQDN.
![5 1](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/74f9af77-8fbd-4a8d-a3b8-c40029743fec)
![5 2](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/5925211d-e195-4d46-a07d-319ee791e7c2)
#### > www.earsurgery.org
<br />

### Q6/. Which TCP stream shows the malware payload being delivered? Provide stream number
![Screenshot 2023-05-17 at 16 39 03](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/951fd69f-b3be-4d04-8b8d-a90d21c28b66)
![Screenshot 2023-05-17 at 16 36 54](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/634922e3-62e1-4181-b0f7-1bb505c66e89)
![Screenshot 2023-05-17 at 16 41 40](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/05f7c815-defc-454d-a484-5ca62f6ad2e1)
#### > 80
<br />

### Q7/. What is the IP address of the C&C server?
#### In the "Suspicious Activity" section on PacketTotal we see that there is a self signed certificate.
![Screenshot 2023-05-18 at 08 26 18](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/8ad60ac7-fe7a-411d-b771-0903a57967c5)
#### > 209.126.97.209
<br />

### Q8/. What is the expiration date of the SSL certificate?
#### Let's filter now with the IP revocered above and go to SSL tab. We get a list of certificates which can be downloaded.
![Screenshot 2023-05-18 at 08 40 44](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/bb94c36e-15fa-4ed9-bc4a-fb34d9d069a0)
#### By downloading one of them and change the file from ".raw" to ".cer" we can open the file and read information on the certificate.
![Screenshot 2023-05-18 at 09 49 13](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/138660ed-1fe8-487d-97e0-3f79824ba815)
#### > 24/11/2014
<br />

### Q9/. The malicious domain served a ZIP archive. What is the name of the DLL file included in this archive?
#### OK so we are looking for a zip file, let's filter type in Brim:
![Screenshot 2023-05-18 at 10 24 37](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/7df0b189-0db6-4eb5-ac03-e316a09d9c1e)
#### Recover MD5 hash and put it on VirusTotal.
![Screenshot 2023-05-18 at 10 27 40](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/ce65613a-d387-400a-b66a-4b8545f5c5b6)
#### In the bundled files we see a flagged DLL file.
![Screenshot 2023-05-18 at 10 28 03](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/5c53cefa-8b77-430d-8a1c-785d4f50e75c)
#### > icVsx1qBrNNdnNjRI.dll
<br />

### Q10/. Extract the malware payload, deobfuscate it, and remove the shellcode at the beginning. This should give you the actual payload (a DLL file) used for the infection. What's the MD5 hash of the payload?
#### Let's export the packet containing the malicious DLL. 
![Screenshot 2023-05-18 at 10 43 40](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/b6f1cafd-7124-4669-a309-d443ac339934)
#### And analyze the exported file on VirusTotal again to confirm we got the correct file.
![Screenshot 2023-05-18 at 10 44 35](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/97febd61-f50e-4565-89ae-1b24f45283ba)
#### Using $strings on the exported file, gives us a repetitive pattern of characters.
![Screenshot 2023-05-18 at 10 47 07](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/b21b6c45-87e2-4b81-b6c8-c4e9e23af842)
#### If we then search for this online with Angler EK we see that it is a XOR string with key "adR2b4nh". XOR ciphers can be decrypted by simply applying the XOR cipher again with the given key to remove the cipher. Let's cook this in CyberChef.
![Screenshot 2023-05-18 at 10 58 57](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/be5e97e5-701d-4656-a609-95c9fb6f02c9)
#### Then download the binary and analyze it with binwalk. Binwalk will extract the DLL.
![Screenshot 2023-05-18 at 11 33 22](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/1afec794-2524-4391-a385-d1a02f032b29)
#### Upload to VirusTotal and get MD5 hash.
![Screenshot 2023-05-18 at 11 44 03](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/ff02b38d-580f-4e00-98c3-6e3c9eeb5824)
#### > 3dfa337e5b3bdb9c2775503bd7539b1c
<br />

### Q11/. What were the two protection methods enabled during the compilation of the PE file? (comma-separated)
#### Using PE Eplorer to analyze the DLL recovered, there is a tab call "Optional Header" which provides informaion on the type of protection methods.
![Screenshot 2023-05-18 at 11 52 21](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/0566ce97-9fc7-4f14-9385-9365da28fa89)
#### > SEH,Canary
<br />
