# CyberDefenders - Malware Traffic Analysis 5
<br />

## Scenario:
<br />

### You're working as a soc analyst at a Security Operations Center (SOC) for a Thanksgiving-themed company. One quiet evening, you hear someone knocking at the SOC analyst's entrance.  As you answer the door, an exhausted mail server technician stumbles in and quickly falls to the floor.  He whispers in a shaky voice, "Mail filters are down...  Spam everywhere..."

### As you help him up, he looks to the sky and yells, "The gates of hell have opened!"The technician immediately collapses again and softly whispers, "The horror...  The horror...".

### The mail filter outage lasted throughout the next day.  Fortunately, very few incidents were reported.  But one example caught your eye. During the mail filter outage, one of the company employees decided to play "email roulette."  The employee opened one of the malicious emails from his inbox and treated it as a legitimate message.
![2015-11-06-traffic-analysis-exercise-image-01](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/afe3703f-fcfe-4aeb-b105-bb5acb3deaf8)
<br />

## Assignement:
<br />

### You acquired four malicious emails the employee received.  You also received a pcap of traffic from his infected computer.  Your task?  Figure out which email was used to compromise the system.

##### Thanks, th3c0rt3x for reviewing the challenge.
<br />

## Questions:


### Q1/. c41-MTA5-email-01: What is the name of the malicious file? 
#### Started by uploading all emails on VirusTotal and inspect them. All mails got flagged as malicious by many security vendors. On first one we go to Behavior tab and check Process Tree to retrieve the name of the malicious file.
![1 1](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/205b1484-817f-4a71-86df-17dcdae7e7f4)
![1 2](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/679f28fc-01d4-45f9-81fb-f6df9b974c4e)
#### > 460630672421.exe
<br />

### Q2/.c41-MTA5-email-01: What is the name of the trojan family the malware belongs to? (As identified by emerging threats ruleset). 
#### Uploaded first email on HybridAnalysis and inspected Related Files to find our executabe. Sandbox reports identified the trojan family.
![2](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/c6995c8a-1bc9-48e3-8feb-64e8dbd3f4ad)
![2 2](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/b60c83a5-e7b6-4d99-8eb1-61790be30780)
#### > Upatre
<br />

### Q3/. c41-MTA5-email-01: The malware dropped two malicious files with the same hash but with different names. Provide the SHA256 hash of those files? (Check the report submitted in 2015). 
#### It literally says to check report from 2015.
![3 1](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/dadc18c6-2d1b-42b8-a5c9-a98c12834b59)
![3 2](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/e7f1be6c-d4ea-4158-816e-b2d1c603da79)
#### > d1818c3fbbb1f09d8998ad44d14ee9a4fbfae5a1bb58128c2ac077a06d7f84b9
<br />

### Q4/. c41-MTA5-email-01: How many DNS requests were initiated by the malware? (Check the report submitted in 2015). 
![4](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/b2193478-e246-4df1-a274-d4ab1b3200aa)
#### > 3
<br />

### Q5/. c41-MTA5-email-02: Multiple streams contain macros in this document. Provide the number of the highest one.
#### I extracted an attachement from the first email, from Microsof Office Suite. I used oletools to anayze and gather info.
![5 1](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/1e8072d0-0032-4e17-b4b6-798b0742344b)
![5 2](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/13a6d953-e101-475c-a2bf-0bc599d2bf42)
![5 3](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/bd8c154b-275a-4945-81f1-c24a2ffd8841)
#### > 20
<br />

### Q6/ .c41-MTA5-email-02: The Excel macro tried to download a file. Provide the full URL of this file? 
#### Upload the Excel document on VirusTotal.
![6](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/83bf0e7a-6777-4fad-9ed6-63d208b9b7a3)
#### > http://advancedgroup.net.au/~incantin/334g5j76/897i7uxqe.exe
<br />

### Q7/. c41-MTA5-email-02: What is the name of the object used to get data from the download URL? 
#### To analyze Microsoft Office documents we're going to use oletools suite. I started by extracting VBA source code.
#### $ olevba -c Bill* > sourceCo.txt
#### Inspecting the source code I saw an object function called "read_same_ch_from3". This fuction will concatenate with the oject value "zilibobe" to another hardcoded string.
<img width="833" alt="7" src="https://github.com/itsoktocryy/CyberDefenders/assets/73375576/52888f2c-0d12-499e-ae57-ab31f143612e">
#### > Microsoft.XMLHTTP
<br />

### Q8/. c41-MTA5-email-02: The Excel macro writes a file to the temp folder. Provide the filename? 
#### Go back to VirusTotal. In the Behavior tab we see written files by the malicious doc.
![8](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/d7184dcc-ae62-4055-92ee-0160728ca586)
#### > tghtop.exe
<br />

### Q9/. c41-MTA5-email-03: Provide the FQDN used by the attacker to store the login credentials?
#### In the DNS section of VirusTotal, we see many Domains that have interacted with the victim.
![9 1](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/e782757b-d5b4-4f26-a80a-7c6583d151e1)
#### I extracted from the 3rd email AmericanExpress.html and uploaded it on HybridAnalysis.
![9 2](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/83069585-7ee8-4545-a37e-f22660f7400c)
#### On the sandbox test form 2018 we see some HTTP traffic making GET requests on FDQN jpmmotos.pt and get a match from the Domains found with VirusTotal.
![9 3](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/8010ff00-f57d-442a-9c07-f6fad60de7cb)
![9 4](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/b35cf8f2-84c8-4780-b37c-809265d5d7d1)
#### > jpmmotos.pt
<br />

### Q10/. c41-MTA5-email-04: How many FQDNs are present in the malicious js
#### I extracted "fax000497762.zip" from 4th email. Unzipped it and got a one liner js script. Used https://beautifier.io/ to make it readable.
![10 1](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/ac3561c6-be6f-47de-bc5e-c1cda5ccbb8e)
#### Then compiled it on https://onecompiler.com/ and got another one liner in output.
![10 2](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/78c1d8bb-b1ae-462c-88b7-5eff0aa89d68)
#### Put it back to beautifier.io to read it.
![10 3](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/6ed8bd29-2f5b-43e8-8c0d-14597eeb9425)
#### > 3
<br />

### Q11/. c41-MTA5-email-04: What is the name of the object used to handle and read files? 
#### > ADODB.Stream
<br />

### Q12/. c41-MTA5.pcap: The victim received multiple emails; however, the user opened a single attachment. Provide the attachment filename.
![12](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/945efc56-4d5c-49a0-a295-aea8a71199d7)
#### I filtered with tshark all GET requests in http stream. We see requests have been made to the same hardcoded address in the js script. We got our proof.
#### $ tshark -r *.pcap -Y "http.request || http.response" -O http| grep -i "GET" -A15 -B15
#### > fax000497762.zip
<br />

### Q13/. c41-MTA5.pcap: What is the IP address of the victim machine?
![13](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/ab3a7136-0bd8-4344-962a-e4769763e629)
#### > 10.3.66.103
<br />

### Q14/.c41-MTA5.pcap: What is the hostname of the victim machine?
#### Filtering with tshark.
![14](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/cd7fb15c-8f1f-47b9-92df-5a2f4b9a0a4b)
#### >STROUT-PC
<br />

### Q15/.c41-MTA5.pcap: What is the FQDN that hosted the malware? 
![15](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/8c308fa2-6578-47e4-9ab3-f3c58b0bdefc)
#### > kennedy.sitoserver.com
<br />

### Q16/.c41-MTA5.pcap: The opened attachment wrote multiple files to the TEMP folder. Provide the name of the first file written to the disk?
#### Analyzing the malicious JavaScript, I can see that once the HTTP GET request is successful, the “saveToFile()” file function is used.
![16 1](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/f4785959-6082-4b24-926a-7cdc1e2931d2)
#### “fn” variable contains a static string value
![16 2](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/210d6c9e-a1ce-49a0-a9f8-bf4e974ea370)
![16 3](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/1be95e09-dffd-416a-b6fc-1d72f7e0d90b)
#### The “fn” variable will then be concatenated with “n” and “.exe” to provide the following filename:
#### >7997551.exe
<br />

### Q17/.c41-MTA5.pcap: One of the written files to the disk has the following md5 hash "35a09d67bee10c6aff48826717680c1c"; Which registry key does this malware check for its existence?
#### #### > 9a83a958-b859-11d1-aa90-00aa00ba3258
<br />

### Q18/.c41-MTA5.pcap: One of the written files to the disk has the following md5 hash "e2fc96114e61288fc413118327c76d93" sent an HTTP post request to "upload.php" page. Provide the webserver IP. (IP is not in PCAP)
#### Analyzed the js script in HybridAnalysis.
![18](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/f6476308-dd90-48d1-ac75-e927610cbd54)
#### > 78.24.220.229
<br />

### Q19/.c41-MTA5.pcap: The malware initiated callback traffic after the infection. Provide the IP of the destination server. 
#### Lot's of packets from this address.
![19 1](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/5d900fdf-af72-42c2-a243-20e4342351b8)
#### Filtered this IP in search.
![19 2](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/2acb07ac-20a1-466f-b806-a727210539d9)
#### In export objects we see many requests involving the sus stream we just saw.
![19 3](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/eb93c9c8-7991-4b14-aca6-97b4116479e8)
![19 4](https://github.com/itsoktocryy/CyberDefenders/assets/73375576/93d35a63-f825-4b15-839e-adacfa184912)
####  > 109.68.191.31
<br />
